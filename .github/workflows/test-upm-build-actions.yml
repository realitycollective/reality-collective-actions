name: Test Unity Build Actions

on:
  push:
    branches: [main, development]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

# Ensure default token scopes and inherit org-level secrets via env mapping
permissions:
  contents: write
  packages: read

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GIT_PAT: ${{ secrets.GIT_PAT }}

jobs:
  test-unity-build:
    name: Test Unity UPM Build
    runs-on: ${{ matrix.os }}
    if: always()
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        unity-version:
          - 6000.0.x
          - 6000
        include:
          - os: ubuntu-latest
            build-targets: StandaloneLinux64, Android, iOS
            build-args: ""
          - os: windows-latest
            build-targets: StandaloneWindows64, Android
            build-args: ""
          - os: macos-latest
            build-targets: StandaloneOSX, Android, iOS, VisionOS
            build-args: ""
    steps:
      - uses: buildalon/unity-setup@v2
        id: unity-setup
        with:
          version-file: "None"
          unity-version: ${{ matrix.unity-version }} # overrides version in version-file
          build-targets: ${{ matrix.build-targets }}

      - run: |
          echo "Step Outputs:"
          echo "steps.unity-setup.unity-hub-path: '${{ steps.unity-setup.outputs.unity-hub-path }}'"
          echo "steps.unity-setup.unity-editors: '${{ steps.unity-setup.outputs.unity-editors }}'"
          echo "steps.unity-setup.unity-editor-path: '${{ steps.unity-setup.outputs.unity-editor-path }}'"
          echo "steps.unity-setup.unity-project-path: '${{ steps.unity-setup.outputs.unity-project-path }}'"

          echo "Environment Variables:"
          echo "UNITY_HUB_PATH: '${{ env.UNITY_HUB_PATH }}'"
          echo "UNITY_EDITORS: '${{ env.UNITY_EDITORS }}'"
          echo "UNITY_EDITOR_PATH: '${{ env.UNITY_EDITOR_PATH }}'"
          echo "UNITY_PROJECT_PATH: '${{ env.UNITY_PROJECT_PATH }}'"

      - name: Checkout Actions (composite source)
        uses: actions/checkout@v5

      - uses: buildalon/activate-unity-license@v2
        if: runner.environment == 'github-hosted'
        with:
          license: "Personal" # Choose license type to use [ Personal, Professional, Floating ]
          username: ${{ secrets.UNITY_USER}}
          password: ${{ secrets.UNITY_ACC}}

      - uses: buildalon/create-unity-project@v2
        id: create-unity-project
        with:
          project-name: P

      - name: Setup Unity UPM Build
        uses: ./setupUnityUPMbuild
        with:
          repository: realitycollective/com.realitycollective.package-test
          unity-project-path: ${{ steps.create-unity-project.outputs.project-path }}
          dependencies: '[{"development": "github.com/realitycollective/com.realitycollective.buildtools.git"},{"development": "github.com/realitycollective/com.realitytoolkit.core.git"},{"development": "github.com/realitycollective/com.realitycollective.utilities.git"},{"development": "github.com/realitycollective/com.realitycollective.service-framework.git"}]'

      - name: Run Unity Build
        uses: ./run-unity-multitarget-build
        with:
          unity-editor-path: ${{ steps.unity-setup.outputs.unity-editor-path }}
          unity-project-path: ${{ steps.create-unity-project.outputs.project-path }}
          build-targets: ${{ matrix.build-targets }}